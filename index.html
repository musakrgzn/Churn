<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telecom Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { 
            background-color: #f0f2f5; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            border: none; 
            border-radius: 12px; 
        }
        .nav-tabs { border-bottom: 2px solid #e9ecef; }
        .nav-tabs .nav-link { color: #6c757d; font-weight: 500; border: none; }
        .nav-tabs .nav-link.active { 
            font-weight: bold; 
            color: #1D3557; 
            border-bottom: 3px solid #1D3557; 
            background: transparent;
        }
        .sonuc-kutusu { display: none; margin-top: 20px; padding: 20px; border-radius: 8px; text-align: left; }
        .riskli { background-color: #fdf5f6; color: #E63946; border: 1px solid #fadbdc; }
        .guvenli { background-color: #f2f5f8; color: #1D3557; border: 1px solid #d5dfe6; }
        .oran-badge { font-size: 1.1rem; float: right; }
        
        .table-gecmis th { background-color: #f8f9fa; color: #495057; font-weight: 600; }
        .table-gecmis td { vertical-align: middle; }
    </style>
</head>
<body>

<div class="container mt-4 mb-5">
    <h2 class="mb-4 text-center fw-bold" style="color: #1D3557;">AI Analysis Center</h2>

    <ul class="nav nav-tabs justify-content-center mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tekil-tab" data-bs-toggle="tab" data-bs-target="#tekil" type="button" role="tab">Single Customer & Database</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="toplu-tab" data-bs-toggle="tab" data-bs-target="#toplu" type="button" role="tab">Corporate Dashboard (CSV)</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="tekil" role="tabpanel">
            <div class="row justify-content-center">
                
                <div class="col-md-5">
                    <div class="card p-4 h-100">
                        <h5 class="mb-4 text-secondary">Customer Risk Profiling</h5>
                        <form id="churnForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted small">Monthly Bill</label>
                                    <input type="number" class="form-control form-control-sm" id="fatura" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted small">Duration (Months)</label>
                                    <input type="number" class="form-control form-control-sm" id="sure" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-muted small">Contract Type</label>
                                <select class="form-select form-select-sm" id="sozlesme">
                                    <option value="Aylik">Month-to-Month</option>
                                    <option value="Yillik">1 Year Contract</option>
                                    <option value="Iki_Yillik">2 Year Contract</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted small">Internet Infrastructure</label>
                                    <select class="form-select form-select-sm" id="internet">
                                        <option value="Fiber">Fiber</option>
                                        <option value="ADSL">ADSL</option>
                                        <option value="Yok">None</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label text-muted small">Tech Support?</label>
                                    <select class="form-select form-select-sm" id="destek">
                                        <option value="Evet">Yes</option>
                                        <option value="Hayir">No</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn text-white w-100 mt-2" style="background-color: #1D3557;">Analyze and Save</button>
                        </form>

                        <div id="sonucAlani" class="sonuc-kutusu mt-3 p-3">
                            <h6 id="tahminMetni" class="d-inline fw-bold"></h6>
                            <span id="ihtimalMetni" class="badge oran-badge float-end"></span>
                            <hr class="my-2">
                            <ul id="nedenlerListesi" class="mt-1 mb-0 fw-medium small text-muted ps-3"></ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-7">
                    <div class="card p-4 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="text-secondary mb-0">Recent Predictions (Database)</h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="gecmisiGetir()">ðŸ”„ Refresh</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm table-gecmis border">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Bill</th>
                                        <th>Duration</th>
                                        <th>Contract</th>
                                        <th>AI Decision</th>
                                        <th>Risk</th>
                                    </tr>
                                </thead>
                                <tbody id="gecmisTablosu">
                                    <tr><td colspan="6" class="text-center text-muted py-3">Loading data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="tab-pane fade" id="toplu" role="tabpanel">
            <div class="row">
                <div class="col-md-12 mb-4">
                    <div class="card p-4 text-center">
                        <h5 class="mb-3 text-secondary">Upload Customer Database (CSV)</h5>
                        <div class="d-flex justify-content-center align-items-center gap-3">
                            <input type="file" id="csvDosyasi" accept=".csv" class="form-control w-50">
                            <button class="btn text-white px-4" style="background-color: #1D3557;" onclick="topluAnalizBaslat()">Generate Report</button>
                        </div>
                    </div>
                </div>

                <div id="dashboardAlani" class="col-md-12" style="display: none;">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card p-3 h-100"><div id="pieChart"></div></div>
                        </div>
                        <div class="col-md-7">
                            <div class="card p-3 h-100"><div id="boxPlot"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
</div>

<script>
    const colorRisk = '#E63946'; 
    const colorSafe = '#1D3557'; 

    async function gecmisiGetir() {
        try {
            const response = await fetch("http://127.0.0.1:8000/gecmis");
            const data = await response.json();
            const tablo = document.getElementById("gecmisTablosu");
            
            if (data.length === 0) {
                tablo.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">No analysis saved yet.</td></tr>';
                return;
            }

            tablo.innerHTML = ""; 

            data.forEach(kayit => {
                let tarihObj = new Date(kayit.islem_tarihi);
                let formatliTarih = tarihObj.toLocaleDateString('en-US') + ' ' + tarihObj.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
                
                let rozetClass = kayit.yapay_zeka_karari.includes("Ayrilacak") ? "bg-danger" : "bg-success";
                let kararMetni = kayit.yapay_zeka_karari.includes("Ayrilacak") ? "High Risk" : "Safe Profile";

                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="text-muted small">${formatliTarih}</td>
                    <td>${kayit.aylik_fatura}</td>
                    <td>${kayit.kullanim_suresi} Mo.</td>
                    <td>${kayit.sozlesme_turu}</td>
                    <td><span class="badge ${rozetClass}">${kararMetni}</span></td>
                    <td><strong>${kayit.risk_orani}</strong></td>
                `;
                tablo.appendChild(tr);
            });
        } catch (error) {
            console.error("Error fetching history:", error);
        }
    }

    document.addEventListener("DOMContentLoaded", gecmisiGetir);

    document.getElementById("churnForm").addEventListener("submit", async function(event) {
        event.preventDefault();

        const musteriVerisi = {
            "Aylik_Fatura": parseFloat(document.getElementById("fatura").value),
            "Toplam_Kullanim_Ay": parseInt(document.getElementById("sure").value),
            "Sozlesme_Turu": document.getElementById("sozlesme").value,
            "Internet_Turu": document.getElementById("internet").value,
            "Teknik_Destek_Aramasi": document.getElementById("destek").value
        };

        try {
            const response = await fetch("http://127.0.0.1:8000/tahmin_et", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(musteriVerisi)
            });

            const data = await response.json();
            
            const sonucAlani = document.getElementById("sonucAlani");
            const tahminMetni = document.getElementById("tahminMetni");
            const ihtimalMetni = document.getElementById("ihtimalMetni");
            const nedenlerListesi = document.getElementById("nedenlerListesi");

            sonucAlani.style.display = "block";
            nedenlerListesi.innerHTML = ""; 
            
            if (data.Sistem_Tahmini === "Ayrilacak (CHURN)") {
                sonucAlani.className = "sonuc-kutusu riskli";
                tahminMetni.innerText = "âš ï¸ HIGH RISK";
                ihtimalMetni.innerText = data.Ayrilma_Ihtimali;
                ihtimalMetni.style.backgroundColor = colorRisk;
            } else {
                sonucAlani.className = "sonuc-kutusu guvenli";
                tahminMetni.innerText = "âœ… SAFE PROFILE";
                ihtimalMetni.innerText = data.Ayrilma_Ihtimali;
                ihtimalMetni.style.backgroundColor = colorSafe;
            }

            data.Risk_Faktorleri.forEach(faktor => {
                let li = document.createElement("li");
                li.innerText = faktor;
                nedenlerListesi.appendChild(li);
            });

            gecmisiGetir();

        } catch (error) {
            alert("API connection error! Make sure the server is running.");
        }
    });

    async function topluAnalizBaslat() {
        const fileInput = document.getElementById('csvDosyasi');
        if (fileInput.files.length === 0) {
            alert("Please select a CSV file first!");
            return;
        }

        const formData = new FormData();
        formData.append("dosya", fileInput.files[0]);

        try {
            const response = await fetch("http://127.0.0.1:8000/toplu_tahmin", {
                method: "POST",
                body: formData
            });

            const data = await response.json();
            document.getElementById("dashboardAlani").style.display = "block";

            let ayrilacakCount = data.filter(d => d.Tahmin_Sonucu === "Ayrilacak").length;
            let kalacakCount = data.length - ayrilacakCount;
            
            let pieData = [{
                values: [ayrilacakCount, kalacakCount],
                labels: ['High Risk Profile', 'Safe Profile'],
                type: 'pie',
                hole: 0.55,
                textinfo: 'percent',
                marker: { colors: [colorRisk, colorSafe], line: { width: 3, color: '#ffffff' } }
            }];
            let pieLayout = {
                title: { text: 'Overall Risk Distribution', font: {size: 16, color: '#495057'} },
                showlegend: true, legend: { orientation: "h", y: -0.1 }, margin: { t: 50, b: 20, l: 20, r: 20 }
            };
            Plotly.newPlot('pieChart', pieData, pieLayout, {displayModeBar: false});

            let faturaAyrilan = data.filter(d => d.Tahmin_Sonucu === "Ayrilacak").map(d => d.Aylik_Fatura);
            let faturaKalan = data.filter(d => d.Tahmin_Sonucu === "Kalacak").map(d => d.Aylik_Fatura);

            let trace1 = { y: faturaAyrilan, type: 'box', name: 'High Risk Customers', marker: {color: colorRisk}, line: {width: 2} };
            let trace2 = { y: faturaKalan, type: 'box', name: 'Safe Customers', marker: {color: colorSafe}, line: {width: 2} };
            
            let boxLayout = {
                title: { text: 'Segmentation by Monthly Bill', font: {size: 16, color: '#495057'} },
                yaxis: { title: 'Monthly Bill', gridcolor: '#e9ecef', zerolinecolor: '#e9ecef' },
                xaxis: { gridcolor: '#e9ecef' },
                showlegend: false, margin: { t: 50, b: 40, l: 50, r: 20 }, plot_bgcolor: 'rgba(0,0,0,0)', paper_bgcolor: 'rgba(0,0,0,0)'
            };
            Plotly.newPlot('boxPlot', [trace1, trace2], boxLayout, {displayModeBar: false});

        } catch (error) {
            alert("Error during analysis. Make sure the server is running.");
            console.error(error);
        }
    }
</script>

</body>
</html>
